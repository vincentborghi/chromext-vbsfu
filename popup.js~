document.getElementById('generateViewBtn').addEventListener('click', () => {
  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    if (tabs[0] && tabs[0].id && tabs[0].url && tabs[0].url.includes('.lightning.force.com/lightning/r/Case/')) {
      chrome.tabs.sendMessage(tabs[0].id, { action: "generateFullCaseView" }, (response) => {
        if (chrome.runtime.lastError) {
          console.error("Error sending message:", chrome.runtime.lastError.message);
          const errorP = document.createElement('p');
          errorP.style.color = 'red';
          errorP.textContent = "Error: Could not connect. Refresh the SF page and retry.";
          document.body.appendChild(errorP);
        } else if (response && response.status === "processing") {
           console.log("Content script is processing.");
           const processingP = document.createElement('p');
           processingP.textContent = "Processing... New tab opening.";
           document.body.appendChild(processingP);
           // Close popup automatically after short delay
           setTimeout(() => window.close(), 1500);
        } else if (response && response.status === "error") {
           console.error("Error from content script:", response.message);
           const errorP = document.createElement('p');
           errorP.style.color = 'red';
           errorP.textContent = `Error: ${response.message}`;
           document.body.appendChild(errorP);
        }
      });
    } else {
       document.body.innerHTML = "<h3>Error</h3><p>This only works on SF Lightning Case pages.</p>";
    }
  });
});
